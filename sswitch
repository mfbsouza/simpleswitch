#!/usr/bin/env bash

OPT=${1?Error: no option given}
BBSWITCH=/etc/modules-load.d/bbswitch.conf

if [ "$OPT" = "status" ]; then
    if [ -e "$BBSWITCH" ]; then
        echo "Intel is on"
    else
        echo "NVIDIA is on"
    fi
fi

if [ "$OPT" = "help" ]; then
	echo ""
	echo "  options:"
	echo "    help"
	echo "    block_nvidia"
	echo "    vgpu"
	echo "    intel"
	echo "    nvidia"
	echo ""
fi

if [ "$OPT" = "block_nvidia" ]; then
    echo "Turning off NVIDIA dGPU..."
    echo "Setting bbswith to start on boot..."
    sudo cp bbswitch-load.conf /etc/modules-load.d/bbswitch.conf
    sudo cp bbswitch.conf /etc/modprobe.d/bbswitch.conf
    echo "Blacklist any NVIDIA drivers..."
    sudo cp simpleswitch.conf /etc/modprobe.d/simpleswitch.conf
    echo "Nvidia card will turn off after next reboot"
fi

if [ "$OPT" = "vgpu" ]; then
    echo "Enabling intel GVT-g on kernel & KVM config"
    sudo cp vgpu-mkinit-intel.conf /etc/mkinitcpio.conf
    sudo mkinitcpio -p linux
    sudo cp vgpu-grub-intel /etc/default/grub
    sudo grub-mkconfig -o /boot/grub/grub.cfg
    echo "Intel GVT-g ready to go. Restart your PC"
	echo "to create a vgpu check gvtvgpu.service file"
fi

if [ "$OPT" = "intel" ]; then
    echo "Turning off NVIDIA dGPU..."
    echo "Setting bbswith to start on boot..."
    sudo cp bbswitch-load.conf /etc/modules-load.d/bbswitch.conf
    sudo cp bbswitch.conf /etc/modprobe.d/bbswitch.conf
    echo "Blacklist any NVIDIA drivers..."
    sudo cp simpleswitch.conf /etc/modprobe.d/simpleswitch.conf
    echo "Removing NVIDIA Optimus X.ORG config"
    sudo rm /etc/X11/xorg.conf
    sudo cp 20-intel.conf /etc/X11/xorg.conf.d/20-intel.conf
    echo "Removing LightDM Nvidia Optimus config"
    sudo rm /etc/lightdm/display_setup.sh
    sudo cp lightdm-intel.conf /etc/lightdm/lightdm.conf
    echo "Removing NVIDIA DMS kernel modsetting"
    sudo cp grub-intel /etc/default/grub
    sudo grub-mkconfig -o /boot/grub/grub.cfg
    sudo cp mkinit-intel.conf /etc/mkinitcpio.conf
    sudo mkinitcpio -p linux
    echo "Intel Graphics ready to go. Please restart your system"
fi

if [ "$OPT" = "nvidia" ]; then
    echo "Turning on NVIDIA dGPU..."
    echo "Removing bbswitch from boot..."
    sudo rm /etc/modules-load.d/bbswitch.conf
    sudo rm /etc/modprobe.d/bbswitch.conf
    echo "Enabling NVIDIA driver..."
    sudo rm /etc/modprobe.d/simpleswitch.conf
    echo "Setting up NVIDIA Optimus X.ORG Config"
    sudo cp xorg-nvidia.conf /etc/X11/xorg.conf
    sudo rm /etc/X11/xorg.conf.d/20-intel.conf
    echo "Setting up LightDM Optimus config"
    sudo cp display_setup.sh /etc/lightdm/display_setup.sh
    sudo chmod +x /etc/lightdm/display_setup.sh
    sudo cp lightdm-nvidia.conf /etc/lightdm/lightdm.conf
    echo "Setting up NVIDIA DMS kernel modsetting"
    sudo cp grub-nvidia /etc/default/grub
    sudo grub-mkconfig -o /boot/grub/grub.cfg
    sudo cp mkinit-nvidia.conf /etc/mkinitcpio.conf
    sudo mkinitcpio -p linux
    echo "Nvidia dGPU ready to go. Please restart your system"
fi
